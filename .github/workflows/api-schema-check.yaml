name: API Schema Check

permissions:
  contents: read
  issues: write

on:
  schedule:
    # Run every Saturday at 9:00 AM UTC
    - cron: "0 9 * * 6"
  workflow_dispatch:
    # Allow manual triggering

jobs:
  check-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"

      - run: uv sync --group dev

      - name: Run live API schema tests
        id: schema-tests
        continue-on-error: true
        run: |
          uv run pytest -m live_api -v --tb=short 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Create issue on failure
        if: steps.schema-tests.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('test-output.txt', 'utf8');

            // Extract failed tests
            const failedTests = output.match(/FAILED.*$/gm) || [];
            const failedList = failedTests.map(t => `- \`${t}\``).join('\n');

            const title = `API Schema Change Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `## NBA API Schema Changes Detected

            The weekly API schema check found new fields in the NBA API responses that are not captured in our models.

            ### Failed Tests
            ${failedList || 'See full output below'}

            ### What This Means
            The NBA API has added new fields to one or more endpoints. Our models should be updated to capture this new data.

            ### Action Required
            1. Review the failed tests to identify which endpoints changed
            2. Update the corresponding response models in \`src/fastbreak/models/\`
            3. Run \`pytest -m live_api\` locally to verify fixes

            <details>
            <summary>Full Test Output</summary>

            \`\`\`
            ${output.slice(-10000)}
            \`\`\`

            </details>

            ---
            *This issue was automatically created by the API Schema Check workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['api-schema', 'automated']
            });

      - name: Fail workflow if tests failed
        if: steps.schema-tests.outputs.exit_code != '0'
        run: exit 1
